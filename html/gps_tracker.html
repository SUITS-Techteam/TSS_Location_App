<!DOCTYPE html>
<html>
<head>
    <title>GPS Tracker (With EVA Control)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial; text-align: center; margin-top: 30px; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; }
        #status { margin-top: 20px; font-size: 16px; white-space: pre-line; }
        #eva-status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>GPS Tracker Web App</h1>

    <!-- EVA Selection Buttons -->
    <button id="btn-eva1" onclick="setCurrentEva('eva1')">Select EVA1</button>
    <button id="btn-eva2" onclick="setCurrentEva('eva2')">Select EVA2</button>

    <div id="eva-status">Current EVA: EVA1</div>

    <!-- Control Buttons -->
    <button id="btn-start" onclick="startTracking()">Start Tracking</button>
    <button id="btn-stop" onclick="stopTracking()" disabled>Stop Tracking</button>

    <p id="status">Press Start to begin tracking.</p>

    <script>
        const serverUrl = "https://192.168.51.201:8443";
        let watchId = null;
        let currentEva = "eva1";

        function setCurrentEva(eva) {
            currentEva = eva;
            document.getElementById('eva-status').innerText = `Current EVA: ${eva.toUpperCase()}`;
        }

        function setButtonState(isTracking) {
            document.getElementById('btn-eva1').disabled = isTracking;
            document.getElementById('btn-eva2').disabled = isTracking;
            document.getElementById('btn-start').disabled = isTracking;
            document.getElementById('btn-stop').disabled = !isTracking;
        }

        function startTracking() {
            if (!navigator.geolocation) {
                document.getElementById('status').innerText = "Geolocation not supported.";
                return;
            }

            if (watchId !== null) {
                document.getElementById('status').innerText = "Already tracking.";
                return;
            }

            setButtonState(true); // Disable all except Stop
            document.getElementById('status').innerText = "Tracking started...";

            watchId = navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const head = position.coords.heading;

                const posx = lon;
                const posy = lat;
                const heading = head; 

                document.getElementById('status').innerText = 
                    `Sending for ${currentEva.toUpperCase()}:\nLongitude = ${posx}\nLatitude = ${posy}\nHeading = ${heading}`;

                // Send data for the selected EVA
                sendSingleValue(`imu_${currentEva}_posx`, posx);
                sendSingleValue(`imu_${currentEva}_posy`, posy);
                sendSingleValue(`imu_${currentEva}_heading`, heading);

            }, error => {
                document.getElementById('status').innerText = `Error getting location: ${error.message}`;
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        }

        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById('status').innerText = "Tracking stopped.";
            } else {
                document.getElementById('status').innerText = "Tracking is not active.";
            }

            setButtonState(false); // Re-enable controls
        }

        function sendSingleValue(paramName, value) {
            paramName = paramName.replace(/=/g, ''); // Sanitize parameter name
            const formData = new URLSearchParams();
            formData.append(paramName, value);

            console.log(`>>> Sending: ${paramName} = ${value}`);

            fetch(serverUrl, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            })
            .then(response => {
                console.log(`${paramName} â†’ Status: ${response.status}`);
                if (!response.ok) {
                    console.error(`Error sending ${paramName}`);
                }
            })
            .catch(err => {
                console.error(`Network error sending ${paramName}: ${err}`);
            });
        }
    </script>
</body>
</html>